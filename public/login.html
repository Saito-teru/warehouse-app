<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ログイン</title>
  <link rel="stylesheet" href="/css/style.css" />
</head>
<body>

<div class="page">
  <section class="panel" style="max-width:520px; margin: 40px auto;">
    <h1 class="title" style="margin-bottom:14px;">ログイン</h1>

    <label class="field" style="display:block; margin-bottom:12px;">
      <span>メールアドレス</span>
      <input id="email" type="email" placeholder="admin@example.com" style="width:100%;" />
    </label>

    <button id="btnLogin" class="btn primary" style="width:100%;">ログイン</button>

    <div id="msg" class="small" style="margin-top:10px; white-space:pre-wrap;"></div>
  </section>
</div>

<script>
(function () {
  const emailEl = document.getElementById("email");
  const btn = document.getElementById("btnLogin");
  const msg = document.getElementById("msg");

  function setMsg(text, isError) {
    msg.textContent = text || "";
    msg.style.color = isError ? "red" : "green";
  }

  async function login() {
    setMsg("");

    const email = (emailEl.value || "").trim();
    if (!email) {
      setMsg("メールアドレスを入力してください。", true);
      return;
    }

    const res = await fetch("/login", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email })
    });

    const text = await res.text();
    let data = null;
    try { data = text ? JSON.parse(text) : null; } catch (e) {}

    if (!res.ok) {
      const err = data && data.error ? data.error : text;
      setMsg("ログインに失敗しました。\n" + err, true);
      return;
    }

    if (!data || !data.token) {
      setMsg("tokenが返ってきませんでした。/login の実装を確認してください。", true);
      return;
    }

    localStorage.setItem("token", data.token);
    setMsg("ログイン成功。移動します…", false);

    // 次に使う画面へ
    location.href = "/calendar.html";
  }

  btn.addEventListener("click", login);
})();
</script>

</body>
</html>
