<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>案件機材割当</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>

<div class="page">
  <header class="topbar">
    <div class="topbar-left">
      <h1 class="title">案件機材割当</h1>
    </div>
    <div class="topbar-right">
      <button id="btnBack" class="btn">カレンダーへ</button>
      <button id="btnLogout" class="btn">ログアウト</button>
    </div>
  </header>

  <section class="panel">
    <div class="row wrap gap">
      <label class="field">
        <span>案件</span>
        <select id="projectSelect"></select>
      </label>

      <button id="btnLoad" class="btn">読み込み</button>
      <button id="btnSave" class="btn primary">保存</button>
    </div>

    <div id="status" class="small" style="margin-top:10px; white-space:pre-wrap;"></div>
  </section>

  <section class="panel" style="overflow-x:auto;">
    <table style="width:100%; border-collapse:collapse;">
      <thead>
        <tr>
          <th style="text-align:left; padding:8px; border-bottom:1px solid rgba(0,0,0,0.12);">機材名</th>
          <th style="text-align:right; padding:8px; border-bottom:1px solid rgba(0,0,0,0.12); width:110px;">総数</th>
          <th style="text-align:right; padding:8px; border-bottom:1px solid rgba(0,0,0,0.12); width:140px;">割当数</th>
        </tr>
      </thead>
      <tbody id="equipmentTable"></tbody>
    </table>
  </section>
</div>

<script>
(function () {
  let equipmentList = [];

  const projectSelect = document.getElementById("projectSelect");
  const equipmentTable = document.getElementById("equipmentTable");
  const statusEl = document.getElementById("status");
  const btnLoad = document.getElementById("btnLoad");
  const btnSave = document.getElementById("btnSave");
  const btnLogout = document.getElementById("btnLogout");
  const btnBack = document.getElementById("btnBack");

  function setStatus(msg, isError) {
    statusEl.textContent = msg || "";
    statusEl.style.color = isError ? "red" : "green";
  }

  function getToken() {
    return localStorage.getItem("token") || "";
  }

  function requireLogin() {
    // ログイン機能実装までスキップ
    return true;
  }

  function getProjectIdFromUrl() {
    const params = new URLSearchParams(location.search);
    const v = params.get("project_id");
    if (!v) return null;
    const n = Number(v);
    if (!Number.isFinite(n) || n <= 0) return null;
    return String(n);
  }

  async function fetchJson(url, options) {
    const res = await fetch(url, options);

    if (res.status === 401) {
      localStorage.removeItem("token");
      location.href = "/login.html";
      return null;
    }

    const text = await res.text();
    let json = null;
    try { json = text ? JSON.parse(text) : null; } catch(e) {}

    if (!res.ok) {
      const msg = json && (json.error || json.message) ? (json.error || json.message) : text;
      throw new Error(`${res.status} ${res.statusText}\nURL: ${url}\n${msg}`);
    }

    return json;
  }

  async function apiGet(url) {
    return await fetchJson(url, {
      headers: { "Content-Type": "application/json" }
    });
  }

  async function apiPost(url, data) {
    return await fetchJson(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data)
    });
  }

  function renderEquipmentTable() {
    equipmentTable.innerHTML = "";

    for (const eq of equipmentList) {
      const tr = document.createElement("tr");

      const tdName = document.createElement("td");
      tdName.style.padding = "8px";
      tdName.textContent = eq.name;

      const tdTotal = document.createElement("td");
      tdTotal.style.padding = "8px";
      tdTotal.style.textAlign = "right";
      tdTotal.textContent = String(eq.total_quantity ?? "");

      const tdQty = document.createElement("td");
      tdQty.style.padding = "8px";
      tdQty.style.textAlign = "right";

      const input = document.createElement("input");
      input.type = "number";
      input.min = "0";
      input.step = "1";
      input.value = "0";
      input.id = "eq_" + eq.id;
      input.style.width = "110px";
      input.style.padding = "8px";
      input.style.borderRadius = "10px";
      input.style.border = "1px solid rgba(0,0,0,0.16)";

      tdQty.appendChild(input);

      tr.appendChild(tdName);
      tr.appendChild(tdTotal);
      tr.appendChild(tdQty);

      equipmentTable.appendChild(tr);
    }
  }

  function clearAllInputsToZero() {
    for (const eq of equipmentList) {
      const input = document.getElementById("eq_" + eq.id);
      if (input) input.value = "0";
    }
  }

  async function loadProjects(targetProjectId) {
    const data = await apiGet("/api/projects");
    if (!data) return;

    const projects = Array.isArray(data) ? data : (data.projects || []);
    projectSelect.innerHTML = "";

    for (const p of projects) {
      const opt = document.createElement("option");
      opt.value = String(p.id);
      opt.textContent = p.title || ("(案件 " + p.id + ")");
      projectSelect.appendChild(opt);
    }

    if (projects.length === 0) {
      setStatus("案件がありません。先に案件を作成してください。", true);
      return;
    }

    if (targetProjectId) {
      const exists = Array.from(projectSelect.options).some(o => o.value === targetProjectId);
      if (exists) projectSelect.value = targetProjectId;
    }
  }

  async function loadEquipment() {
    const data = await apiGet("/api/equipment");
    if (!data) return;

    equipmentList = data.equipment || [];
    renderEquipmentTable();

    if (equipmentList.length === 0) {
      setStatus("機材がありません。先に機材登録をしてください。", true);
    }
  }

  async function loadAssignments() {
    setStatus("");

    const projectId = projectSelect.value;
    if (!projectId) {
      setStatus("案件を選択してください。", true);
      return;
    }

    if (equipmentList.length === 0) {
      setStatus("機材が0件です。先に機材登録をしてください。", true);
      return;
    }

    clearAllInputsToZero();

    const data = await apiGet("/api/project-items?project_id=" + encodeURIComponent(projectId));
    if (!data) return;

    const items = data.items || [];
    for (const item of items) {
      const input = document.getElementById("eq_" + item.equipment_id);
      if (input) input.value = String(item.quantity || 0);
    }

    setStatus("読み込みました。", false);
  }

  async function saveAssignments() {
    setStatus("");

    const projectId = projectSelect.value;
    if (!projectId) {
      setStatus("案件を選択してください。", true);
      return;
    }

    const items = [];

    for (const eq of equipmentList) {
      const input = document.getElementById("eq_" + eq.id);
      const qty = input ? Number(input.value) : 0;
      if (Number.isFinite(qty) && qty > 0) {
        items.push({ equipment_id: eq.id, quantity: qty });
      }
    }

    await apiPost("/api/project-items", { project_id: Number(projectId), items });
    setStatus("保存しました。", false);
  }

  async function init() {
    if (!requireLogin()) return;

    btnBack.addEventListener("click", () => {
      location.href = "/calendar.html";
    });

    btnLogout.addEventListener("click", () => {
      localStorage.removeItem("token");
      location.href = "/login.html";
    });

    btnLoad.addEventListener("click", () => {
      loadAssignments().catch(err => {
        console.error(err);
        setStatus("読み込みに失敗しました。\n\n" + err.message, true);
      });
    });

    btnSave.addEventListener("click", () => {
      saveAssignments().catch(err => {
        console.error(err);
        setStatus("保存に失敗しました。\n\n" + err.message, true);
      });
    });

    try {
      const targetProjectId = getProjectIdFromUrl();
      await loadProjects(targetProjectId);
      await loadEquipment();

      if (projectSelect.value && equipmentList.length > 0) {
        await loadAssignments();
      }
    } catch (err) {
      console.error(err);
      setStatus("初期化に失敗しました。\n\n" + err.message, true);
    }
  }

  init();
})();
</script>

<script src="/js/auth.js"></script>
</body>
</html>
